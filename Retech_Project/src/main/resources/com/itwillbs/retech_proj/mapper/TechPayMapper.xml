<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
[ 엑세스토큰 및 핀테크 사용자 정보를 관리할 bank_user_info 테이블 정의 ]
CREATE TABLE techpay_user_info (
	techpay_mem_id VARCHAR(100) PRIMARY KEY,
	access_token VARCHAR(400) UNIQUE,
	refresh_token VARCHAR(400) UNIQUE,
	user_seq_no VARCHAR(10) UNIQUE,
	user_ci VARCHAR(100) UNIQUE,
	fintech_use_num VARCHAR(30) UNIQUE,
	FOREIGN KEY (techpay_mem_id) REFERENCES member(member_id) ON DELETE CASCADE
);
-->     
<mapper namespace="com.itwillbs.retech_proj.mapper.TechPayMapper"> 

	<!-- 핀테크 사용자 정보 조회 - SELECT -->
	<!-- member 테이블 정보도 함께 조회하여 이름을 가져오기 -->
	<select id="selectBankUserInfo" resultType="bankToken">
		SELECT *
		FROM techpay_user_info AS b
		LEFT JOIN member AS m
		ON b.techpay_mem_id = m.member_id
		WHERE b.techpay_mem_id = #{id}
	</select>

	<!-- 사용자 엑세스 토큰 정보 조회 - SELECT -->
	<!-- 전달받은 Map 객체 내의 "id" 속성을 활용하여 아이디 조회 -->
	<select id="selectId" resultType="string">
		SELECT techpay_mem_id
		FROM techpay_user_info
		WHERE techpay_mem_id = #{id}	
	</select>

	<!-- 핀테크 엑세스토큰 정보 등록 - INSERT -->
	<insert id="insertAccessToken">
		INSERT INTO techpay_user_info
		VALUES (
			#{id}
			, #{token.access_token}
			, #{token.refresh_token}
			, #{token.user_seq_no}
			, #{token.user_ci}
			, #{token.fintech_use_num}   -- 임시(사용자 계좌가 1개라는 전제 하에 계좌번호 대신 핀테크 사용자 번호 저장)
		)
	</insert>
	
	<!-- 핀테크 엑세스토큰 정보 갱신 - UPDATE -->
	<update id="updateAccessToken">
		UPDATE techpay_user_info
		SET
			access_token = #{token.access_token}
			, refresh_token = #{token.refresh_token}
		WHERE
			techpay_mem_id = #{id}	
	</update>

</mapper>